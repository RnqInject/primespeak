<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrimeSpeak - Электронный журнал</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a237e;
            --primary-light: #534bae;
            --primary-dark: #000051;
            --secondary: #ff9800;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ffc107;
            --info: #2196f3;
            --light: #f5f7fa;
            --dark: #263238;
            --gray: #78909c;
            --border: #e0e0e0;
            --sor-color: #9c27b0;
            --soch-color: #ff5722;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            min-height: 100vh;
        }
        
        /* Login Page */
        .login-page {
            display: flex;
            min-height: 100vh;
            background: white;
        }
        
        .login-left {
            flex: 1;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: white;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 50px;
        }
        
        .login-logo i {
            font-size: 4rem;
            color: white;
            margin-bottom: 20px;
        }
        
        .login-logo h1 {
            font-size: 2.5rem;
            font-weight: 600;
        }
        
        .login-logo span {
            color: var(--secondary);
        }
        
        .login-right {
            width: 450px;
            padding: 50px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: white;
        }
        
        .login-box {
            width: 100%;
        }
        
        .login-title {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 30px;
            font-weight: 600;
        }
        
        .login-form .form-group {
            margin-bottom: 20px;
        }
        
        .input-with-icon {
            position: relative;
        }
        
        .input-with-icon i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .login-form input {
            width: 100%;
            padding: 14px 15px 14px 45px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }
        
        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--dark);
        }
        
        .remember-me input {
            width: auto;
            padding: 0;
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            background: var(--primary-dark);
        }
        
        .login-error {
            color: var(--danger);
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(244, 67, 54, 0.1);
            border-radius: 6px;
            display: none;
            font-size: 0.9rem;
        }
        
        /* Main App */
        .app-container {
            display: none;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: white;
            padding: 0 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 1000;
            height: 70px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2rem;
            color: var(--primary);
        }
        
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .logo span {
            color: var(--secondary);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .quarter-selector {
            display: flex;
            background: var(--light);
            padding: 4px;
            border-radius: 8px;
        }
        
        .quarter-btn {
            padding: 8px 20px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray);
            transition: all 0.3s;
        }
        
        .quarter-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 15px;
            border-radius: 8px;
            background: var(--light);
            cursor: pointer;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }
        
        .user-role {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        /* Main Container */
        .main-container {
            display: flex;
            min-height: calc(100vh - 70px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            padding: 25px 0;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
            border-right: 1px solid var(--border);
        }
        
        .nav-section {
            margin-bottom: 25px;
            padding: 0 20px;
        }
        
        .nav-section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--gray);
            margin-bottom: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            margin-bottom: 5px;
            color: var(--dark);
            text-decoration: none;
            font-size: 0.95rem;
        }
        
        .nav-item:hover {
            background-color: rgba(26, 35, 126, 0.05);
            color: var(--primary);
        }
        
        .nav-item.active {
            background-color: rgba(26, 35, 126, 0.1);
            color: var(--primary);
            font-weight: 500;
        }
        
        .nav-item i {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: var(--light);
        }
        
        .page-header {
            background: white;
            padding: 25px 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .page-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .page-title h2 {
            color: var(--primary);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-title h2 i {
            color: var(--secondary);
        }
        
        .page-subtitle {
            color: var(--gray);
            font-size: 0.95rem;
            margin-bottom: 25px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.2);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }
        
        .btn-info {
            background: var(--info);
            color: white;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.85rem;
        }
        
        /* Tables */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        
        .table-header {
            padding: 20px 25px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h3 {
            color: var(--dark);
            font-size: 1.1rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
        }
        
        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
            font-size: 0.9rem;
        }
        
        td {
            padding: 16px 15px;
            border-bottom: 1px solid var(--border);
            font-size: 0.95rem;
        }
        
        tr:hover {
            background: #fafafa;
        }
        
        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .badge-success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }
        
        .badge-warning {
            background: rgba(255, 152, 0, 0.1);
            color: var(--secondary);
        }
        
        .badge-danger {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger);
        }
        
        .badge-info {
            background: rgba(33, 150, 243, 0.1);
            color: var(--info);
        }
        
        /* Forms */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.9rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px 25px;
            background: var(--primary);
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 1.3rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 3000;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .notification.success {
            background: var(--success);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.warning {
            background: var(--warning);
            color: var(--dark);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .empty-state p {
            margin-bottom: 20px;
        }
        
        /* Rating */
        .rating-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin: 0 auto;
        }
        
        .rating-excellent {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
        }
        
        .rating-good {
            background: linear-gradient(135deg, #FFC107, #FF9800);
            color: white;
        }
        
        .rating-average {
            background: linear-gradient(135deg, #FF9800, #FF5722);
            color: white;
        }
        
        .rating-poor {
            background: linear-gradient(135deg, #F44336, #D32F2F);
            color: white;
        }
        
        /* Grade Input */
        .grade-input {
            width: 70px;
            text-align: center;
            padding: 8px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
        }
        
        .grade-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .grade-label {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 3px;
        }
        
        /* Attendance */
        .attendance-btn {
            width: 32px;
            height: 32px;
            border: 2px solid var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .attendance-btn.present {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .attendance-btn.absent {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        .attendance-btn.late {
            background: var(--warning);
            color: var(--dark);
            border-color: var(--warning);
        }
        
        .attendance-btn:hover {
            transform: scale(1.1);
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-card .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark);
        }
        
        .stat-card .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 4px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .login-page {
                flex-direction: column;
            }
            
            .login-left {
                padding: 30px;
            }
            
            .login-right {
                width: 100%;
                padding: 30px;
            }
            
            .sidebar {
                width: 70px;
            }
            
            .nav-item span,
            .nav-section-title {
                display: none;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-page" id="loginPage">
        <div class="login-left">
            <div class="login-logo">
                <i class="fas fa-graduation-cap"></i>
                <h1>Prime<span>Speak</span></h1>
            </div>
        </div>
        
        <div class="login-right">
            <div class="login-box">
                <div class="login-title">Вход в систему</div>
                
                <form class="login-form" id="loginForm">
                    <div class="form-group">
                        <div class="input-with-icon">
                            <i class="fas fa-user"></i>
                            <input type="text" id="loginEmail" placeholder="Логин" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="input-with-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="loginPassword" placeholder="Пароль" required>
                        </div>
                    </div>
                    
                    <div class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        <label for="rememberMe">Запомнить меня</label>
                    </div>
                    
                    <button type="submit" class="login-btn">
                        Войти
                    </button>
                    
                    <div class="login-error" id="loginError">
                        Неверный логин или пароль
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <header class="header">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                <h1>Prime<span>Speak</span></h1>
            </div>
            
            <div class="header-right">
                <div class="quarter-selector">
                    <button class="quarter-btn active" data-quarter="1">I четверть</button>
                    <button class="quarter-btn" data-quarter="2">II четверть</button>
                    <button class="quarter-btn" data-quarter="3">III четверть</button>
                    <button class="quarter-btn" data-quarter="4">IV четверть</button>
                </div>
                
                <div class="user-info" id="userDropdown">
                    <div class="user-avatar" id="userAvatar">А</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Администратор</div>
                        <div class="user-role" id="userRole">Администратор</div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="main-container">
            <nav class="sidebar">
                <!-- Navigation will be dynamically loaded based on user role -->
                <div id="dynamicNav"></div>
            </nav>
            
            <main class="main-content" id="mainContent">
                <!-- Content will be dynamically loaded based on user role -->
            </main>
        </div>
    </div>

    <script>
        // БАЗА ДАННЫХ В LOCALSTORAGE
        let database = {
            users: {},
            classes: {},
            teachers: {},
            students: {},
            grades: {},
            attendance: {},
            tests: {}
        };

        // Текущий пользователь
        let currentUser = null;
        let currentPage = 'dashboard';
        let currentQuarter = 1;

        // DOM элементы
        const loginPage = document.getElementById('loginPage');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const rememberMe = document.getElementById('rememberMe');
        const dynamicNav = document.getElementById('dynamicNav');
        const mainContent = document.getElementById('mainContent');

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            loadDatabase();
            updateCurrentDate();
            checkRememberedUser();
            setupEventListeners();
            
            if (currentUser) {
                updatePageContent();
            }
        });

        // Загрузить базу данных
        function loadDatabase() {
            const savedData = localStorage.getItem('primeSpeakDatabase');
            if (savedData) {
                database = JSON.parse(savedData);
            } else {
                initializeDatabase();
            }
            
            // Создать админа если нет
            if (!database.users['admin']) {
                database.users['admin'] = {
                    password: 'admin123',
                    role: 'admin',
                    name: 'Администратор',
                    email: 'admin@primespeak.kz'
                };
                saveDatabase();
            }
        }

        // Инициализировать базу данных с примерами
        function initializeDatabase() {
            database = {
                users: {
                    'admin': {
                        password: 'admin123',
                        role: 'admin',
                        name: 'Администратор',
                        email: 'admin@primespeak.kz'
                    },
                    'john': {
                        password: 'teacher123',
                        role: 'teacher',
                        name: 'John Smith',
                        email: 'john@primespeak.kz',
                        phone: '+7 777 123 4567',
                        subject: 'Английский язык',
                        classes: ['Beginner A1'],
                        bio: 'Опыт преподавания 5 лет',
                        status: 'active'
                    },
                    'ivanov': {
                        password: 'student123',
                        role: 'student',
                        name: 'Иванов Иван',
                        email: 'ivanov@example.com',
                        phone: '+7 777 111 2233',
                        class: 'Beginner A1',
                        teacher: 'john',
                        birthDate: '2010-05-15',
                        parentPhone: '+7 777 444 5566',
                        notes: '',
                        status: 'active'
                    },
                    'petrov': {
                        password: 'student123',
                        role: 'student',
                        name: 'Петров Петр',
                        email: 'petrov@example.com',
                        phone: '+7 777 222 3344',
                        class: 'Beginner A1',
                        teacher: 'john',
                        birthDate: '2011-07-20',
                        parentPhone: '+7 777 555 6677',
                        notes: '',
                        status: 'active'
                    }
                },
                classes: {
                    'Beginner A1': {
                        level: 'A1',
                        teacher: 'john',
                        students: ['ivanov', 'petrov'],
                        maxStudents: 15,
                        startTime: '09:00',
                        endTime: '10:30',
                        days: ['Пн', 'Ср', 'Пт'],
                        description: 'Курс для начинающих',
                        status: 'active'
                    },
                    'Intermediate B1': {
                        level: 'B1',
                        teacher: 'john',
                        students: [],
                        maxStudents: 12,
                        startTime: '11:00',
                        endTime: '12:30',
                        days: ['Вт', 'Чт'],
                        description: 'Средний уровень',
                        status: 'active'
                    }
                },
                teachers: {
                    'john': {
                        name: 'John Smith',
                        subject: 'Английский язык',
                        classes: ['Beginner A1', 'Intermediate B1'],
                        email: 'john@primespeak.kz',
                        phone: '+7 777 123 4567',
                        status: 'active'
                    }
                },
                students: {
                    'ivanov': {
                        name: 'Иванов Иван',
                        class: 'Beginner A1',
                        teacher: 'john',
                        email: 'ivanov@example.com',
                        phone: '+7 777 111 2233',
                        status: 'active'
                    },
                    'petrov': {
                        name: 'Петров Петр',
                        class: 'Beginner A1',
                        teacher: 'john',
                        email: 'petrov@example.com',
                        phone: '+7 777 222 3344',
                        status: 'active'
                    }
                },
                grades: {
                    'ivanov': {
                        'Beginner A1': {
                            1: [ // I четверть
                                { date: '2024-01-15', type: 'test', topic: 'Present Simple', grade: 8, max: 10 },
                                { date: '2024-01-22', type: 'homework', topic: 'Vocabulary', grade: 9, max: 10 },
                                { date: '2024-01-29', type: 'test', topic: 'Контрольная работа 1', grade: 18, max: 25 },
                                { date: '2024-02-05', type: 'classwork', topic: 'Reading', grade: 7, max: 10 },
                                { date: '2024-02-12', type: 'test', topic: 'Past Simple', grade: 9, max: 10 }
                            ],
                            2: [ // II четверть
                                { date: '2024-03-05', type: 'test', topic: 'Future Simple', grade: 8, max: 10 }
                            ]
                        }
                    },
                    'petrov': {
                        'Beginner A1': {
                            1: [
                                { date: '2024-01-15', type: 'test', topic: 'Present Simple', grade: 6, max: 10 },
                                { date: '2024-01-22', type: 'homework', topic: 'Vocabulary', grade: 8, max: 10 },
                                { date: '2024-01-29', type: 'test', topic: 'Контрольная работа 1', grade: 21, max: 25 },
                                { date: '2024-02-05', type: 'classwork', topic: 'Reading', grade: 9, max: 10 }
                            ]
                        }
                    }
                },
                attendance: {
                    'Beginner A1': {
                        '2024-01-15': {
                            'ivanov': 'present',
                            'petrov': 'absent'
                        },
                        '2024-01-22': {
                            'ivanov': 'present',
                            'petrov': 'late'
                        },
                        '2024-01-29': {
                            'ivanov': 'present',
                            'petrov': 'present'
                        }
                    }
                },
                tests: {
                    'Beginner A1': [
                        { id: 'test1', name: 'Контрольная работа 1', date: '2024-01-29', maxPoints: 25, topics: ['Present Simple', 'Vocabulary'] },
                        { id: 'test2', name: 'Итоговый тест за четверть', date: '2024-02-26', maxPoints: 30, topics: ['Present Simple', 'Past Simple', 'Vocabulary'] }
                    ]
                }
            };
            saveDatabase();
        }

        // Сохранить базу данных
        function saveDatabase() {
            localStorage.setItem('primeSpeakDatabase', JSON.stringify(database));
        }

        // Настроить события
        function setupEventListeners() {
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                const remember = rememberMe.checked;
                
                if (database.users[username] && database.users[username].password === password) {
                    const user = database.users[username];
                    
                    if (remember) {
                        localStorage.setItem('primeSpeakRememberedUser', JSON.stringify({
                            username: username,
                            password: password,
                            role: user.role,
                            name: user.name
                        }));
                        localStorage.setItem('primeSpeakRememberMe', 'true');
                    } else {
                        localStorage.removeItem('primeSpeakRememberedUser');
                        localStorage.removeItem('primeSpeakRememberMe');
                    }
                    
                    loginUser(username, user.role, user.name);
                } else {
                    showLoginError();
                }
            });

            // Событие для переключения четвертей
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('quarter-btn')) {
                    document.querySelectorAll('.quarter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    currentQuarter = parseInt(e.target.dataset.quarter);
                    updatePageContent();
                }
            });
        }

        // Вход пользователя
        function loginUser(username, role, name) {
            currentUser = { username, role, name };
            
            // Обновить UI
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            
            userAvatar.textContent = name.charAt(0);
            userName.textContent = name;
            userRole.textContent = role === 'admin' ? 'Администратор' : 
                                   role === 'teacher' ? 'Учитель' : 'Ученик';
            
            // Переключиться на приложение
            loginPage.style.display = 'none';
            appContainer.style.display = 'block';
            
            // Показать приветствие
            showNotification(`Добро пожаловать, ${name}!`, 'success');
            
            // Загрузить навигацию и начальную страницу
            loadNavigation();
            switchPage('dashboard');
        }

        // Загрузить навигацию в зависимости от роли
        function loadNavigation() {
            let navHTML = '';
            
            if (currentUser.role === 'admin') {
                navHTML = `
                    <div class="nav-section">
                        <div class="nav-section-title">Администратор</div>
                        <ul class="nav-menu">
                            <li class="nav-item active" data-page="dashboard">
                                <i class="fas fa-home"></i>
                                <span>Главная</span>
                            </li>
                            <li class="nav-item" data-page="students">
                                <i class="fas fa-users"></i>
                                <span>Ученики</span>
                            </li>
                            <li class="nav-item" data-page="teachers">
                                <i class="fas fa-chalkboard-teacher"></i>
                                <span>Учителя</span>
                            </li>
                            <li class="nav-item" data-page="classes">
                                <i class="fas fa-school"></i>
                                <span>Классы</span>
                            </li>
                            <li class="nav-item" data-page="profile">
                                <i class="fas fa-user"></i>
                                <span>Профиль</span>
                            </li>
                        </ul>
                    </div>
                `;
            } else if (currentUser.role === 'teacher') {
                navHTML = `
                    <div class="nav-section">
                        <div class="nav-section-title">Учитель</div>
                        <ul class="nav-menu">
                            <li class="nav-item active" data-page="teacher-dashboard">
                                <i class="fas fa-home"></i>
                                <span>Главная</span>
                            </li>
                            <li class="nav-item" data-page="teacher-classes">
                                <i class="fas fa-users"></i>
                                <span>Мои классы</span>
                            </li>
                            <li class="nav-item" data-page="teacher-grades">
                                <i class="fas fa-star"></i>
                                <span>Оценки</span>
                            </li>
                            <li class="nav-item" data-page="teacher-attendance">
                                <i class="fas fa-calendar-check"></i>
                                <span>Посещаемость</span>
                            </li>
                            <li class="nav-item" data-page="teacher-tests">
                                <i class="fas fa-file-alt"></i>
                                <span>Контрольные работы</span>
                            </li>
                            <li class="nav-item" data-page="teacher-profile">
                                <i class="fas fa-user"></i>
                                <span>Профиль</span>
                            </li>
                        </ul>
                    </div>
                `;
            } else if (currentUser.role === 'student') {
                navHTML = `
                    <div class="nav-section">
                        <div class="nav-section-title">Ученик</div>
                        <ul class="nav-menu">
                            <li class="nav-item active" data-page="student-dashboard">
                                <i class="fas fa-home"></i>
                                <span>Главная</span>
                            </li>
                            <li class="nav-item" data-page="student-grades">
                                <i class="fas fa-star"></i>
                                <span>Мои оценки</span>
                            </li>
                            <li class="nav-item" data-page="student-schedule">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Расписание</span>
                            </li>
                            <li class="nav-item" data-page="student-tests">
                                <i class="fas fa-file-alt"></i>
                                <span>Контрольные работы</span>
                            </li>
                            <li class="nav-item" data-page="student-profile">
                                <i class="fas fa-user"></i>
                                <span>Мой профиль</span>
                            </li>
                        </ul>
                    </div>
                `;
            }
            
            navHTML += `
                <div class="nav-section">
                    <div class="nav-section-title">Общее</div>
                    <ul class="nav-menu">
                        <li class="nav-item" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Выйти</span>
                        </li>
                    </ul>
                </div>
            `;
            
            dynamicNav.innerHTML = navHTML;
            
            // Назначить события навигации
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.id !== 'logoutBtn' && item.dataset.page) {
                    item.addEventListener('click', () => {
                        switchPage(item.dataset.page);
                        
                        // Обновить активное состояние
                        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                    });
                }
            });
            
            // Кнопка выхода
            document.getElementById('logoutBtn').addEventListener('click', logoutUser);
        }

        // Переключение страниц
        function switchPage(page) {
            currentPage = page;
            mainContent.innerHTML = '';
            
            switch(currentUser.role) {
                case 'admin':
                    loadAdminPage(page);
                    break;
                case 'teacher':
                    loadTeacherPage(page);
                    break;
                case 'student':
                    loadStudentPage(page);
                    break;
            }
        }

        // Загрузить страницу админа
        function loadAdminPage(page) {
            switch(page) {
                case 'dashboard':
                    loadAdminDashboard();
                    break;
                case 'students':
                    loadStudentsPage();
                    break;
                case 'teachers':
                    loadTeachersPage();
                    break;
                case 'classes':
                    loadClassesPage();
                    break;
                case 'profile':
                    loadProfilePage();
                    break;
            }
        }

        // Загрузить страницу учителя
        function loadTeacherPage(page) {
            switch(page) {
                case 'teacher-dashboard':
                    loadTeacherDashboard();
                    break;
                case 'teacher-classes':
                    loadTeacherClasses();
                    break;
                case 'teacher-grades':
                    loadTeacherGrades();
                    break;
                case 'teacher-attendance':
                    loadTeacherAttendance();
                    break;
                case 'teacher-tests':
                    loadTeacherTests();
                    break;
                case 'teacher-profile':
                    loadTeacherProfile();
                    break;
            }
        }

        // Загрузить страницу ученика
        function loadStudentPage(page) {
            switch(page) {
                case 'student-dashboard':
                    loadStudentDashboard();
                    break;
                case 'student-grades':
                    loadStudentGrades();
                    break;
                case 'student-schedule':
                    loadStudentSchedule();
                    break;
                case 'student-tests':
                    loadStudentTests();
                    break;
                case 'student-profile':
                    loadStudentProfile();
                    break;
            }
        }

        // === СТРАНИЦЫ АДМИНИСТРАТОРА ===

        function loadAdminDashboard() {
            const stats = calculateAdminStats();
            
            mainContent.innerHTML = `
                <div class="page-header">
                    <div class="page-title">
                        <h2><i class="fas fa-home"></i> Панель администратора</h2>
                        <div id="currentDate"></div>
                    </div>
                    <div class="page-subtitle">
                        Управление системой электронного журнала
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(33, 150, 243, 0.1); color: var(--info);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value">${stats.students}</div>
                        <div class="stat-label">Учеников</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(156, 39, 176, 0.1); color: var(--sor-color);">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div class="stat-value">${stats.teachers}</div>
                        <div class="stat-label">Учителей</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(76, 175, 80, 0.1); color: var(--success);">
                            <i class="fas fa-school"></i>
                        </div>
                        <div class="stat-value">${stats.classes}</div>
                        <div class="stat-label">Классов</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(255, 152, 0, 0.1); color: var(--secondary);">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="stat-value">${stats.subjects}</div>
                        <div class="stat-label">Предметов</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>Последние действия</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Действие</th>
                                <th>Пользователь</th>
                                <th>Детали</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${new Date().toLocaleDateString('ru-RU')}</td>
                                <td>Вход в систему</td>
                                <td>${currentUser.name}</td>
                                <td>Административная панель</td>
                            </tr>
                            <tr>
                                <td>2024-01-29</td>
                                <td>Добавлена оценка</td>
                                <td>John Smith</td>
                                <td>Иванов Иван - Контрольная работа: 18/25</td>
                            </tr>
                            <tr>
                                <td>2024-01-22</td>
                                <td>Отмечена посещаемость</td>
                                <td>John Smith</td>
                                <td>Петров Петр - Опоздание</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            updateCurrentDate();
        }

        function calculateAdminStats() {
            const studentsCount = Object.keys(database.students).length;
            const teachersCount = Object.keys(database.teachers).length;
            const classesCount = Object.keys(database.classes).length;
            const subjects = new Set(Object.values(database.teachers).map(t => t.subject));
            const subjectsCount = subjects.size;
            
            return {
                students: studentsCount,
                teachers: teachersCount,
                classes: classesCount,
                subjects: subjectsCount
            };
        }

        // === СТРАНИЦЫ УЧИТЕЛЯ ===

        function loadTeacherDashboard() {
            const teacher = database.teachers[currentUser.username];
            const teacherClasses = teacher?.classes || [];
            const stats = calculateTeacherStats();
            
            mainContent.innerHTML = `
                <div class="page-header">
                    <div class="page-title">
                        <h2><i class="fas fa-home"></i> Панель учителя</h2>
                        <div id="currentDate"></div>
                    </div>
                    <div class="page-subtitle">
                        Добро пожаловать, ${teacher?.name || currentUser.name}!
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(33, 150, 243, 0.1); color: var(--info);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value">${teacherClasses.length}</div>
                        <div class="stat-label">Мои классы</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(76, 175, 80, 0.1); color: var(--success);">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-value">${stats.totalGrades}</div>
                        <div class="stat-label">Оценок выставлено</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(255, 152, 0, 0.1); color: var(--secondary);">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-value">${stats.attendanceDays}</div>
                        <div class="stat-label">Дней с посещаемостью</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(156, 39, 176, 0.1); color: var(--sor-color);">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="stat-value">${stats.totalTests}</div>
                        <div class="stat-label">Контрольных работ</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>Сегодняшние занятия</h3>
                    </div>
                    <div id="todayClasses">
                        <div class="empty-state">
                            <i class="fas fa-calendar"></i>
                            <h3>Нет занятий на сегодня</h3>
                            <p>Расписание занятий на сегодня отсутствует</p>
                        </div>
                    </div>
                </div>
            `;
            
            updateCurrentDate();
            loadTodayClasses();
        }

        function calculateTeacherStats() {
            const teacher = database.teachers[currentUser.username];
            let totalGrades = 0;
            let attendanceDays = 0;
            let totalTests = 0;
            
            if (teacher && teacher.classes) {
                teacher.classes.forEach(className => {
                    // Подсчитать оценки
                    Object.values(database.grades).forEach(studentGrades => {
                        if (studentGrades[className] && studentGrades[className][currentQuarter]) {
                            totalGrades += studentGrades[className][currentQuarter].length;
                        }
                    });
                    
                    // Подсчитать дни посещаемости
                    if (database.attendance[className]) {
                        attendanceDays += Object.keys(database.attendance[className]).length;
                    }
                    
                    // Подсчитать контрольные работы
                    if (database.tests[className]) {
                        totalTests += database.tests[className].length;
                    }
                });
            }
            
            return { totalGrades, attendanceDays, totalTests };
        }

        function loadTodayClasses() {
            const today = new Date().toLocaleDateString('ru-RU', { weekday: 'short' });
            const dayMap = {
                'пн': 'Пн',
                'вт': 'Вт',
                'ср': 'Ср',
                'чт': 'Чт',
                'пт': 'Пт',
                'сб': 'Сб'
            };
            
            const todayShort = dayMap[today.toLowerCase()] || today.substring(0, 2);
            const teacher = database.teachers[currentUser.username];
            
            if (!teacher || !teacher.classes) return;
            
            const todayClasses = teacher.classes.filter(className => {
                const classInfo = database.classes[className];
                return classInfo && classInfo.days && classInfo.days.includes(todayShort);
            });
            
            if (todayClasses.length > 0) {
                const container = document.getElementById('todayClasses');
                let html = '<table><thead><tr><th>Класс</th><th>Время</th><th>Учеников</th><th>Действия</th></tr></thead><tbody>';
                
                todayClasses.forEach(className => {
                    const classInfo = database.classes[className];
                    const studentCount = classInfo.students ? classInfo.students.length : 0;
                    
                    html += `
                        <tr>
                            <td><strong>${className}</strong></td>
                            <td>${classInfo.startTime} - ${classInfo.endTime}</td>
                            <td>${studentCount} учеников</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="openGradeModal('${className}')">
                                    <i class="fas fa-star"></i> Оценки
                                </button>
                                <button class="btn btn-info btn-sm" onclick="openAttendanceModal('${className}')" style="margin-left: 5px;">
                                    <i class="fas fa-calendar-check"></i> Посещаемость
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            }
        }

        function loadTeacherClasses() {
            const teacher = database.teachers[currentUser.username];
            const teacherClasses = teacher?.classes || [];
            
            mainContent.innerHTML = `
                <div class="page-header">
                    <div class="page-title">
                        <h2><i class="fas fa-users"></i> Мои классы</h2>
                        <button class="btn btn-primary" onclick="createNewClass()">
                            <i class="fas fa-plus"></i> Создать класс
                        </button>
                    </div>
                    <div class="page-subtitle">
                        Управление классами и расписанием
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>Список классов</h3>
                    </div>
                    <div id="classesList">
                        ${teacherClasses.length > 0 ? '' : `
                            <div class="empty-state">
                                <i class="fas fa-school"></i>
                                <h3>Нет классов</h3>
                                <p>У вас пока нет назначенных классов</p>
                                <button class="btn btn-primary" onclick="createNewClass()">
                                    <i class="fas fa-plus"></i> Создать класс
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            if (teacherClasses.length > 0) {
                const container = document.getElementById('classesList');
                let html = '<table><thead><tr><th>Класс</th><th>Уровень</th><th>Учеников</th><th>Расписание</th><th>Средний балл</th><th>Действия</th></tr></thead><tbody>';
                
                teacherClasses.forEach(className => {
                    const classInfo = database.classes[className];
                    const studentCount = classInfo?.students?.length || 0;
                    const avgGrade = calculateClassAverage(className);
                    
                    html += `
                        <tr>
                            <td><strong>${className}</strong></td>
                            <td>${classInfo?.level || '—'}</td>
                            <td>${studentCount} / ${classInfo?.maxStudents || 15}</td>
                            <td>${classInfo?.days?.join(', ') || '—'} ${classInfo?.startTime || ''}-${classInfo?.endTime || ''}</td>
                            <td>
                                <div class="rating-circle ${getRatingClass(avgGrade)}">
                                    ${avgGrade.toFixed(1)}
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="openClassDetails('${className}')">
                                    <i class="fas fa-eye"></i> Просмотр
                                </button>
                                <button class="btn btn-success btn-sm" onclick="openGradeModal('${className}')" style="margin-left: 5px;">
                                    <i class="fas fa-star"></i> Оценки
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            }
        }

        function calculateClassAverage(className) {
            let total = 0;
            let count = 0;
            
            Object.values(database.grades).forEach(studentGrades => {
                if (studentGrades[className] && studentGrades[className][currentQuarter]) {
                    studentGrades[className][currentQuarter].forEach(grade => {
                        const percentage = (grade.grade / grade.max) * 10;
                        total += percentage;
                        count++;
                    });
                }
            });
            
            return count > 0 ? total / count : 0;
        }

        function getRatingClass(grade) {
            if (grade >= 8.5) return 'rating-excellent';
            if (grade >= 7) return 'rating-good';
            if (grade >= 5) return 'rating-average';
            return 'rating-poor';
        }

        // Модальное окно для выставления оценок
        window.openGradeModal = function(className) {
            const classInfo = database.classes[className];
            const students = classInfo?.students || [];
            
            let modalHTML = `
                <div class="modal" id="gradeModal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Выставление оценок - ${className}</h3>
                            <button class="close-modal" onclick="closeModal('gradeModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="gradeType">Тип оценки</label>
                                    <select id="gradeType" class="grade-type-select">
                                        <option value="classwork">Работа в классе</option>
                                        <option value="homework">Домашняя работа</option>
                                        <option value="test">Тест</option>
                                        <option value="control">Контрольная работа</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="gradeTopic">Тема</label>
                                    <input type="text" id="gradeTopic" placeholder="Например: Present Simple">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="gradeDate">Дата</label>
                                    <input type="date" id="gradeDate" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div class="form-group">
                                    <label for="maxPoints">Максимальный балл</label>
                                    <select id="maxPoints" class="max-points-select">
                                        <option value="10">10 баллов</option>
                                        <option value="25">25 баллов (контрольная)</option>
                                        <option value="custom">Другое</option>
                                    </select>
                                    <input type="number" id="customMaxPoints" placeholder="Введите значение" style="display: none; margin-top: 5px;">
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <h4 style="margin-bottom: 15px;">Оценки учеников:</h4>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Ученик</th>
                                            <th>Оценка</th>
                                            <th>Баллы</th>
                                            <th>Комментарий</th>
                                        </tr>
                                    </thead>
                                    <tbody id="gradeStudentsList">
            `;
            
            students.forEach(studentUsername => {
                const student = database.students[studentUsername];
                if (student) {
                    modalHTML += `
                        <tr>
                            <td><strong>${student.name}</strong></td>
                            <td>
                                <input type="number" min="0" max="10" step="0.5" 
                                       class="grade-input student-grade" 
                                       data-student="${studentUsername}"
                                       placeholder="0-10">
                                <div class="grade-label">/10</div>
                            </td>
                            <td>
                                <input type="number" min="0" 
                                       class="grade-input student-points" 
                                       data-student="${studentUsername}"
                                       placeholder="0-25"
                                       style="display: none;">
                                <div class="grade-label points-label" style="display: none;">/25</div>
                            </td>
                            <td>
                                <input type="text" class="grade-comment" 
                                       data-student="${studentUsername}"
                                       placeholder="Комментарий" style="width: 100%; padding: 8px;">
                            </td>
                        </tr>
                    `;
                }
            });
            
            modalHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-danger" onclick="closeModal('gradeModal')">Отмена</button>
                            <button class="btn btn-success" onclick="saveGrades('${className}')">
                                <i class="fas fa-save"></i> Сохранить оценки
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Добавить модальное окно на страницу
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Настроить события
            document.getElementById('gradeType').addEventListener('change', function() {
                const isTest = this.value === 'test' || this.value === 'control';
                document.querySelectorAll('.student-points, .points-label').forEach(el => {
                    el.style.display = isTest ? 'block' : 'none';
                });
                document.querySelectorAll('.student-grade').forEach(el => {
                    el.style.display = isTest ? 'none' : 'block';
                });
            });
            
            document.getElementById('maxPoints').addEventListener('change', function() {
                const customInput = document.getElementById('customMaxPoints');
                customInput.style.display = this.value === 'custom' ? 'block' : 'none';
            });
        };

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        function saveGrades(className) {
            const gradeType = document.getElementById('gradeType').value;
            const gradeTopic = document.getElementById('gradeTopic').value.trim();
            const gradeDate = document.getElementById('gradeDate').value;
            const maxPointsSelect = document.getElementById('maxPoints');
            let maxPoints = 10;
            
            if (maxPointsSelect.value === 'custom') {
                maxPoints = parseInt(document.getElementById('customMaxPoints').value) || 10;
            } else {
                maxPoints = parseInt(maxPointsSelect.value);
            }
            
            if (!gradeTopic) {
                showNotification('Введите тему оценки', 'error');
                return;
            }
            
            const classInfo = database.classes[className];
            const students = classInfo?.students || [];
            
            students.forEach(studentUsername => {
                let gradeValue = 0;
                
                if (gradeType === 'test' || gradeType === 'control') {
                    const pointsInput = document.querySelector(`.student-points[data-student="${studentUsername}"]`);
                    gradeValue = pointsInput ? parseFloat(pointsInput.value) : 0;
                } else {
                    const gradeInput = document.querySelector(`.student-grade[data-student="${studentUsername}"]`);
                    gradeValue = gradeInput ? parseFloat(gradeInput.value) : 0;
                }
                
                if (gradeValue > 0) {
                    // Инициализировать структуру оценок если нужно
                    if (!database.grades[studentUsername]) {
                        database.grades[studentUsername] = {};
                    }
                    if (!database.grades[studentUsername][className]) {
                        database.grades[studentUsername][className] = {};
                    }
                    if (!database.grades[studentUsername][className][currentQuarter]) {
                        database.grades[studentUsername][className][currentQuarter] = [];
                    }
                    
                    // Добавить оценку
                    database.grades[studentUsername][className][currentQuarter].push({
                        date: gradeDate,
                        type: gradeType,
                        topic: gradeTopic,
                        grade: gradeValue,
                        max: maxPoints,
                        teacher: currentUser.username
                    });
                }
            });
            
            saveDatabase();
            closeModal('gradeModal');
            showNotification('Оценки успешно сохранены!', 'success');
            
            // Обновить страницу если нужно
            if (currentPage === 'teacher-grades' || currentPage === 'teacher-dashboard') {
                switchPage(currentPage);
            }
        }

        // Модальное окно для посещаемости
        window.openAttendanceModal = function(className) {
            const classInfo = database.classes[className];
            const students = classInfo?.students || [];
            const today = new Date().toISOString().split('T')[0];
            
            let modalHTML = `
                <div class="modal" id="attendanceModal" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Посещаемость - ${className}</h3>
                            <button class="close-modal" onclick="closeModal('attendanceModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="attendanceDate">Дата занятия</label>
                                    <input type="date" id="attendanceDate" value="${today}">
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <h4 style="margin-bottom: 15px;">Отметить посещаемость:</h4>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Ученик</th>
                                            <th>Присутствие</th>
                                            <th>Статус</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendanceStudentsList">
            `;
            
            students.forEach(studentUsername => {
                const student = database.students[studentUsername];
                if (student) {
                    const currentAttendance = database.attendance[className] && 
                                             database.attendance[className][today] && 
                                             database.attendance[className][today][studentUsername];
                    
                    modalHTML += `
                        <tr>
                            <td><strong>${student.name}</strong></td>
                            <td>
                                <div style="display: flex; gap: 10px;">
                                    <button class="attendance-btn present ${currentAttendance === 'present' ? 'present' : ''}"
                                            data-student="${studentUsername}"
                                            data-status="present">
                                        П
                                    </button>
                                    <button class="attendance-btn absent ${currentAttendance === 'absent' ? 'absent' : ''}"
                                            data-student="${studentUsername}"
                                            data-status="absent">
                                        Н
                                    </button>
                                    <button class="attendance-btn late ${currentAttendance === 'late' ? 'late' : ''}"
                                            data-student="${studentUsername}"
                                            data-status="late">
                                        О
                                    </button>
                                </div>
                            </td>
                            <td id="attendanceStatus_${studentUsername}">
                                ${currentAttendance === 'present' ? 'Присутствовал' : 
                                  currentAttendance === 'absent' ? 'Отсутствовал' : 
                                  currentAttendance === 'late' ? 'Опоздал' : 'Не отмечен'}
                            </td>
                        </tr>
                    `;
                }
            });
            
            modalHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-danger" onclick="closeModal('attendanceModal')">Отмена</button>
                            <button class="btn btn-success" onclick="saveAttendance('${className}')">
                                <i class="fas fa-save"></i> Сохранить посещаемость
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Настроить кнопки посещаемости
            document.querySelectorAll('.attendance-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const student = this.dataset.student;
                    const status = this.dataset.status;
                    
                    // Сбросить все кнопки для этого студента
                    document.querySelectorAll(`.attendance-btn[data-student="${student}"]`).forEach(b => {
                        b.classList.remove('present', 'absent', 'late');
                    });
                    
                    // Установить выбранный статус
                    this.classList.add(status);
                    
                    // Обновить текст статуса
                    const statusText = {
                        'present': 'Присутствовал',
                        'absent': 'Отсутствовал',
                        'late': 'Опоздал'
                    }[status];
                    
                    document.getElementById(`attendanceStatus_${student}`).textContent = statusText;
                });
            });
        };

        function saveAttendance(className) {
            const attendanceDate = document.getElementById('attendanceDate').value;
            
            if (!attendanceDate) {
                showNotification('Выберите дату', 'error');
                return;
            }
            
            // Инициализировать структуру посещаемости если нужно
            if (!database.attendance[className]) {
                database.attendance[className] = {};
            }
            if (!database.attendance[className][attendanceDate]) {
                database.attendance[className][attendanceDate] = {};
            }
            
            // Сохранить статусы
            document.querySelectorAll('.attendance-btn[data-student]').forEach(btn => {
                const student = btn.dataset.student;
                const status = btn.dataset.status;
                
                if (btn.classList.contains(status)) {
                    database.attendance[className][attendanceDate][student] = status;
                }
            });
            
            saveDatabase();
            closeModal('attendanceModal');
            showNotification('Посещаемость сохранена!', 'success');
        }

        function loadTeacherGrades() {
            const teacher = database.teachers[currentUser.username];
            const teacherClasses = teacher?.classes || [];
            
            mainContent.innerHTML = `
                <div class="page-header">
                    <div class="page-title">
                        <h2><i class="fas fa-star"></i> Оценки</h2>
                        <div style="display: flex; gap: 10px;">
                            <select id="classFilter" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;">
                                <option value="">Все классы</option>
                                ${teacherClasses.map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                            <select id="gradeTypeFilter" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;">
                                <option value="">Все типы</option>
                                <option value="classwork">Работа в классе</option>
                                <option value="homework">Домашняя работа</option>
                                <option value="test">Тест</option>
                                <option value="control">Контрольная</option>
                            </select>
                        </div>
                    </div>
                    <div class="page-subtitle">
                        Управление оценками учеников
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>Оценки за ${currentQuarter}-ю четверть</h3>
                        <button class="btn btn-primary" onclick="openGradeModal('${teacherClasses[0] || ''}')">
                            <i class="fas fa-plus"></i> Добавить оценку
                        </button>
                    </div>
                    <div id="gradesTable">
                        <!-- Таблица оценок будет загружена здесь -->
                    </div>
                </div>
            `;
            
            loadGradesTable();
            
            // Настроить фильтры
            document.getElementById('classFilter').addEventListener('change', loadGradesTable);
            document.getElementById('gradeTypeFilter').addEventListener('change', loadGradesTable);
        }

        function loadGradesTable() {
            const selectedClass = document.getElementById('classFilter')?.value;
            const selectedType = document.getElementById('gradeTypeFilter')?.value;
            const container = document.getElementById('gradesTable');
            
            if (!container) return;
            
            let allGrades = [];
            const teacher = database.teachers[currentUser.username];
            const classesToShow = selectedClass ? [selectedClass] : (teacher?.classes || []);
            
            classesToShow.forEach(className => {
                Object.entries(database.grades).forEach(([studentUsername, studentGrades]) => {
                    if (studentGrades[className] && studentGrades[className][currentQuarter]) {
                        studentGrades[className][currentQuarter].forEach(grade => {
                            if (!selectedType || grade.type === selectedType) {
                                const student = database.students[studentUsername];
                                if (student) {
                                    allGrades.push({
                                        student: student.name,
                                        className: className,
                                        date: grade.date,
                                        type: grade.type,
                                        topic: grade.topic,
                                        grade: grade.grade,
                                        max: grade.max,
                                        percentage: (grade.grade / grade.max) * 10
                                    });
                                }
                            }
                        });
                    }
                });
            });
            
            if (allGrades.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-star"></i>
                        <h3>Нет оценок</h3>
                        <p>Начните выставлять оценки вашим ученикам</p>
                        <button class="btn btn-primary" onclick="openGradeModal('${classesToShow[0] || ''}')">
                            <i class="fas fa-plus"></i> Добавить оценку
                        </button>
                    </div>
                `;
                return;
            }
            
            // Сортировка по дате
            allGrades.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Ученик</th>
                            <th>Класс</th>
                            <th>Тип</th>
                            <th>Тема</th>
                            <th>Оценка</th>
                            <th>Баллы</th>
                            <th>%</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            allGrades.forEach((grade, index) => {
                const gradeDisplay = grade.max === 10 ? grade.grade.toFixed(1) : `${grade.grade}/${grade.max}`;
                const percentage = grade.percentage.toFixed(1);
                
                html += `
                    <tr>
                        <td>${grade.date}</td>
                        <td><strong>${grade.student}</strong></td>
                        <td>${grade.className}</td>
                        <td>
                            <span class="badge ${
                                grade.type === 'control' ? 'badge-danger' : 
                                grade.type === 'test' ? 'badge-warning' : 
                                grade.type === 'homework' ? 'badge-info' : 'badge-success'
                            }">
                                ${grade.type === 'classwork' ? 'Классная' : 
                                  grade.type === 'homework' ? 'Домашняя' : 
                                  grade.type === 'test' ? 'Тест' : 'Контрольная'}
                            </span>
                        </td>
                        <td>${grade.topic}</td>
                        <td>
                            <div class="rating-circle ${getRatingClass(grade.percentage)}" style="width: 40px; height: 40px; font-size: 1rem;">
                                ${grade.max === 10 ? grade.grade.toFixed(1) : ((grade.grade / grade.max) * 10).toFixed(1)}
                            </div>
                        </td>
                        <td><strong>${gradeDisplay}</strong></td>
                        <td>${percentage}%</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteGrade(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // === СТРАНИЦЫ УЧЕНИКА ===

        function loadStudentDashboard() {
            const student = database.students[currentUser.username];
            const className = student?.class || '';
            const classInfo = database.classes[className];
            const grades = database.grades[currentUser.username] || {};
            const stats = calculateStudentStats();
            
            mainContent.innerHTML = `
                <div class="page-header">
                    <div class="page-title">
                        <h2><i class="fas fa-home"></i> Личный кабинет</h2>
                        <div id="currentDate"></div>
                    </div>
                    <div class="page-subtitle">
                        Добро пожаловать, ${student?.name || currentUser.name}!
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(33, 150, 243, 0.1); color: var(--info);">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-value">${stats.averageGrade.toFixed(1)}</div>
                        <div class="stat-label">Средний балл</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${stats.averageGrade * 10}%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(76, 175, 80, 0.1); color: var(--success);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-value">${stats.totalGrades}</div>
                        <div class="stat-label">Всего оценок</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(255, 152, 0, 0.1); color: var(--secondary);">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-value">${stats.attendanceRate}%</div>
                        <div class="stat-label">Посещаемость</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${stats.attendanceRate}%"></div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(156, 39, 176, 0.1); color: var(--sor-color);">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-value">${stats.rank}</div>
                        <div class="stat-label">Место в классе</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>Последние оценки</h3>
                    </div>
                    <div id="recentGrades">
                        <!-- Последние оценки будут загружены здесь -->
                    </div>
                </div>
                
                <div class="table-container" style="margin-top: 20px;">
                    <div class="table-header">
                        <h3>Сегодняшнее расписание</h3>
                    </div>
                    <div id="todaySchedule">
                        <!-- Расписание на сегодня будет загружено здесь -->
                    </div>
                </div>
            `;
            
            updateCurrentDate();
            loadStudentRecentGrades();
            loadStudentTodaySchedule();
        }

        function calculateStudentStats() {
            const student = database.students[currentUser.username];
            const className = student?.class || '';
            
            let totalGrades = 0;
            let gradeSum = 0;
            let attendancePresent = 0;
            let attendanceTotal = 0;
            
            // Рассчитать оценки
            if (database.grades[currentUser.username] && database.grades[currentUser.username][className]) {
                const quarterGrades = database.grades[currentUser.username][className][currentQuarter] || [];
                totalGrades = quarterGrades.length;
                
                quarterGrades.forEach(grade => {
                    const percentage = (grade.grade / grade.max) * 10;
                    gradeSum += percentage;
                });
            }
            
            // Рассчитать посещаемость
            if (database.attendance[className]) {
                Object.values(database.attendance[className]).forEach(dayAttendance => {
                    const status = dayAttendance[currentUser.username];
                    if (status) {
                        attendanceTotal++;
                        if (status === 'present') attendancePresent++;
                    }
                });
            }
            
            const averageGrade = totalGrades > 0 ? gradeSum / totalGrades : 0;
            const attendanceRate = attendanceTotal > 0 ? (attendancePresent / attendanceTotal) * 100 : 0;
            
            // Рассчитать место в классе (простой пример)
            let rank = 1;
            const classStudents = database.classes[className]?.students || [];
            
            return {
                averageGrade,
                totalGrades,
                attendanceRate: Math.round(attendanceRate),
                rank
            };
        }

        function loadStudentRecentGrades() {
            const student = database.students[currentUser.username];
            const className = student?.class || '';
            const container = document.getElementById('recentGrades');
            
            if (!container) return;
            
            const grades = database.grades[currentUser.username] || {};
            const classGrades = grades[className] || {};
            const quarterGrades = classGrades[currentQuarter] || [];
            
            if (quarterGrades.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <i class="fas fa-star"></i>
                        <h4>Нет оценок</h4>
                        <p>У вас пока нет оценок за эту четверть</p>
                    </div>
                `;
                return;
            }
            
            // Взять последние 5 оценок
            const recentGrades = [...quarterGrades]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Тип</th>
                            <th>Тема</th>
                            <th>Оценка</th>
                            <th>Баллы</th>
                            <th>Учитель</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            recentGrades.forEach(grade => {
                const teacher = database.teachers[grade.teacher];
                const teacherName = teacher ? teacher.name.split(' ')[0] : '—';
                const gradeDisplay = grade.max === 10 ? grade.grade.toFixed(1) : `${grade.grade}/${grade.max}`;
                const percentage = ((grade.grade / grade.max) * 10).toFixed(1);
                
                html += `
                    <tr>
                        <td>${grade.date}</td>
                        <td>
                            <span class="badge ${
                                grade.type === 'control' ? 'badge-danger' : 
                                grade.type === 'test' ? 'badge-warning' : 
                                grade.type === 'homework' ? 'badge-info' : 'badge-success'
                            }">
                                ${grade.type === 'classwork' ? 'Классная' : 
                                  grade.type === 'homework' ? 'Домашняя' : 
                                  grade.type === 'test' ? 'Тест' : 'Контрольная'}
                            </span>
                        </td>
                        <td>${grade.topic}</td>
                        <td>
                            <div class="rating-circle ${getRatingClass(percentage)}" style="width: 40px; height: 40px; font-size: 1rem;">
                                ${grade.max === 10 ? grade.grade.toFixed(1) : percentage}
                            </div>
                        </td>
                        <td><strong>${gradeDisplay}</strong></td>
                        <td>${teacherName}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function loadStudentTodaySchedule() {
            const student = database.students[currentUser.username];
            const className = student?.class || '';
            const classInfo = database.classes[className];
            const container = document.getElementById('todaySchedule');
            
            if (!container || !classInfo) return;
            
            const today = new Date().toLocaleDateString('ru-RU', { weekday: 'short' });
            const dayMap = {
                'пн': 'Пн',
                'вт': 'Вт',
                'ср': 'Ср',
                'чт': 'Чт',
                'пт': 'Пт',
                'сб': 'Сб'
            };
            
            const todayShort = dayMap[today.toLowerCase()] || today.substring(0, 2);
            
            if (classInfo.days && classInfo.days.includes(todayShort)) {
                container.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                            <div>
                                <h4 style="color: var(--primary); margin-bottom: 5px;">${className}</h4>
                                <p style="color: var(--gray);">${classInfo.description || 'Английский язык'}</p>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: var(--light); padding: 15px; border-radius: 8px;">
                                <div style="font-size: 0.9rem; color: var(--gray);">Время</div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--dark);">
                                    ${classInfo.startTime} - ${classInfo.endTime}
                                </div>
                            </div>
                            
                            <div style="background: var(--light); padding: 15px; border-radius: 8px;">
                                <div style="font-size: 0.9rem; color: var(--gray);">Учитель</div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--dark);">
                                    ${database.teachers[classInfo.teacher]?.name || '—'}
                                </div>
                            </div>
                            
                            <div style="background: var(--light); padding: 15px; border-radius: 8px;">
                                <div style="font-size: 0.9rem; color: var(--gray);">Уровень</div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--dark);">
                                    ${classInfo.level}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <i class="fas fa-calendar"></i>
                        <h4>Нет занятий</h4>
                        <p>Сегодня у вас нет занятий</p>
                    </div>
                `;
            }
        }

        function loadStudentGrades() {
            const student = database.students[currentUser.username];
            const className = student?.class || '';
            const grades = database.grades[currentUser.username] || {};
            const classGrades = grades[className] || {};
            const quarterGrades = classGrades[currentQuarter] || [];
            
            // Рассчитать статистику
            let totalSum = 0;
            let gradeCount = 0;
            const gradeByType = {
                classwork: { sum: 0, count: 0 },
                homework: { sum: 0, count: 0 },
                test: { sum: 0, count: 0 },
                control: { sum: 0, count: 0 }
            };
            
            quarterGrades.forEach(grade => {
                const gradeValue = (grade.grade / grade.max) * 10;
                totalSum += gradeValue;
                gradeCount++;
                
                if (gradeByType[grade.type]) {
                    gradeByType[grade.type].sum += gradeValue;
                    gradeByType[grade.type].count++;
                }
            });
            
            const averageGrade = gradeCount > 0 ? (totalSum / gradeCount) : 0;
            
            mainContent.innerHTML = `
                <div class="page-header">
                    <div class="page-title">
                        <h2><i class="fas fa-star"></i> Мои оценки</h2>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="rating-circle ${getRatingClass(averageGrade)}" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                ${averageGrade.toFixed(1)}
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: var(--gray);">Средний балл</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--dark);">
                                    ${averageGrade.toFixed(1)} / 10
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="page-subtitle">
                        ${currentQuarter}-я четверть • ${className}
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="stat-label">Работа в классе</div>
                                <div class="stat-value">
                                    ${gradeByType.classwork.count > 0 ? (gradeByType.classwork.sum / gradeByType.classwork.count).toFixed(1) : '—'}
                                </div>
                            </div>
                            <div class="stat-icon" style="background: rgba(76, 175, 80, 0.1); color: var(--success); width: 40px; height: 40px;">
                                <i class="fas fa-chalkboard"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="stat-label">Домашняя работа</div>
                                <div class="stat-value">
                                    ${gradeByType.homework.count > 0 ? (gradeByType.homework.sum / gradeByType.homework.count).toFixed(1) : '—'}
                                </div>
                            </div>
                            <div class="stat-icon" style="background: rgba(33, 150, 243, 0.1); color: var(--info); width: 40px; height: 40px;">
                                <i class="fas fa-home"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="stat-label">Тесты</div>
                                <div class="stat-value">
                                    ${gradeByType.test.count > 0 ? (gradeByType.test.sum / gradeByType.test.count).toFixed(1) : '—'}
                                </div>
                            </div>
                            <div class="stat-icon" style="background: rgba(255, 152, 0, 0.1); color: var(--warning); width: 40px; height: 40px;">
                                <i class="fas fa-file-alt"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="stat-label">Контрольные</div>
                                <div class="stat-value">
                                    ${gradeByType.control.count > 0 ? (gradeByType.control.sum / gradeByType.control.count).toFixed(1) : '—'}
                                </div>
                            </div>
                            <div class="stat-icon" style="background: rgba(244, 67, 54, 0.1); color: var(--danger); width: 40px; height: 40px;">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>Все оценки за ${currentQuarter}-ю четверть</h3>
                    </div>
                    <div id="allGradesTable">
                        <!-- Все оценки будут загружены здесь -->
                    </div>
                </div>
            `;
            
            loadAllStudentGrades();
        }

        function loadAllStudentGrades() {
            const student = database.students[currentUser.username];
            const className = student?.class || '';
            const container = document.getElementById('allGradesTable');
            
            if (!container) return;
            
            const grades = database.grades[currentUser.username] || {};
            const classGrades = grades[className] || {};
            const quarterGrades = classGrades[currentQuarter] || [];
            
            if (quarterGrades.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-star"></i>
                        <h3>Нет оценок</h3>
                        <p>У вас пока нет оценок за эту четверть</p>
                    </div>
                `;
                return;
            }
            
            // Сортировка по дате
            const sortedGrades = [...quarterGrades].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Тип</th>
                            <th>Тема</th>
                            <th>Оценка</th>
                            <th>Баллы</th>
                            <th>Процент</th>
                            <th>Учитель</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sortedGrades.forEach(grade => {
                const teacher = database.teachers[grade.teacher];
                const gradeDisplay = grade.max === 10 ? grade.grade.toFixed(1) : `${grade.grade}/${grade.max}`;
                const percentage = ((grade.grade / grade.max) * 100).toFixed(1);
                const grade10 = (grade.grade / grade.max) * 10;
                
                html += `
                    <tr>
                        <td>${grade.date}</td>
                        <td>
                            <span class="badge ${
                                grade.type === 'control' ? 'badge-danger' : 
                                grade.type === 'test' ? 'badge-warning' : 
                                grade.type === 'homework' ? 'badge-info' : 'badge-success'
                            }">
                                ${grade.type === 'classwork' ? 'Классная' : 
                                  grade.type === 'homework' ? 'Домашняя' : 
                                  grade.type === 'test' ? 'Тест' : 'Контрольная'}
                            </span>
                        </td>
                        <td>${grade.topic}</td>
                        <td>
                            <div class="rating-circle ${getRatingClass(grade10)}" style="width: 40px; height: 40px; font-size: 1rem;">
                                ${grade10.toFixed(1)}
                            </div>
                        </td>
                        <td><strong>${gradeDisplay}</strong></td>
                        <td>${percentage}%</td>
                        <td>${teacher ? teacher.name.split(' ')[0] : '—'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function loadStudentSchedule() {
            const student = database.students[currentUser.username];
            const className = student?.class || '';
            const classInfo = database.classes[className];
            
            mainContent.innerHTML = `
                <div class="page-header">
                    <div class="page-title">
                        <h2><i class="fas fa-calendar-alt"></i> Расписание</h2>
                        <button class="btn btn-primary" onclick="printSchedule()">
                            <i class="fas fa-print"></i> Распечатать
                        </button>
                    </div>
                    <div class="page-subtitle">
                        Расписание занятий на неделю
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>Расписание - ${className}</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span style="color: var(--gray); font-size: 0.9rem;">Учитель:</span>
                            <span style="font-weight: 500;">${database.teachers[classInfo?.teacher]?.name || '—'}</span>
                        </div>
                    </div>
                    <div id="weeklySchedule">
                        <!-- Расписание будет загружено здесь -->
                    </div>
                </div>
            `;
            
            loadWeeklySchedule();
        }

        function loadWeeklySchedule() {
            const student = database.students[currentUser.username];
            const className = student?.class || '';
            const classInfo = database.classes[className];
            const container = document.getElementById('weeklySchedule');
            
            if (!container || !classInfo) return;
            
            const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>День недели</th>
                            <th>Время</th>
                            <th>Предмет</th>
                            <th>Уровень</th>
                            <th>Учитель</th>
                            <th>Статус</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const today = new Date().toLocaleDateString('ru-RU', { weekday: 'short' });
            const dayMap = {
                'пн': 'Пн',
                'вт': 'Вт',
                'ср': 'Ср',
                'чт': 'Чт',
                'пт': 'Пт',
                'сб': 'Сб'
            };
            
            const todayShort = dayMap[today.toLowerCase()] || today.substring(0, 2);
            
            days.forEach(day => {
                const hasClass = classInfo.days && classInfo.days.includes(day);
                const isToday = day === todayShort;
                
                html += `
                    <tr ${isToday ? 'style="background: rgba(26, 35, 126, 0.05);"' : ''}>
                        <td>
                            <strong>${day}</strong>
                            ${isToday ? '<span class="badge badge-primary" style="margin-left: 8px;">Сегодня</span>' : ''}
                        </td>
                        <td>
                            ${hasClass ? `<strong>${classInfo.startTime} - ${classInfo.endTime}</strong>` : '—'}
                        </td>
                        <td>${hasClass ? 'Английский язык' : '—'}</td>
                        <td>${hasClass ? classInfo.level : '—'}</td>
                        <td>${hasClass ? (database.teachers[classInfo.teacher]?.name || '—') : '—'}</td>
                        <td>
                            ${hasClass ? 
                                `<span class="badge badge-success">Занятие</span>` : 
                                `<span class="badge" style="background: rgba(120, 144, 156, 0.1); color: var(--gray);">Выходной</span>`
                            }
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <div style="padding: 20px; background: var(--light); margin-top: 20px; border-radius: 8px;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Информация о классе:</h4>
                    <p>${classInfo.description || 'Английский язык'}</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div>
                            <div style="font-size: 0.9rem; color: var(--gray);">Всего занятий в неделю</div>
                            <div style="font-size: 1.2rem; font-weight: bold;">${classInfo.days?.length || 0}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--gray);">Длительность занятия</div>
                            <div style="font-size: 1.2rem; font-weight: bold;">
                                ${calculateDuration(classInfo.startTime, classInfo.endTime)}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--gray);">Учеников в классе</div>
                            <div style="font-size: 1.2rem; font-weight: bold;">
                                ${classInfo.students?.length || 0} / ${classInfo.maxStudents || 15}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function calculateDuration(startTime, endTime) {
            if (!startTime || !endTime) return '—';
            
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            const diff = (end - start) / (1000 * 60); // разница в минутах
            
            const hours = Math.floor(diff / 60);
            const minutes = diff % 60;
            
            return `${hours} ч ${minutes} мин`;
        }

        // === ОБЩИЕ ФУНКЦИИ ===

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                dateElement.textContent = now.toLocaleDateString('ru-RU', options);
            }
        }

        function checkRememberedUser() {
            const rememberedUser = localStorage.getItem('primeSpeakRememberedUser');
            const rememberMeFlag = localStorage.getItem('primeSpeakRememberMe');
            
            if (rememberMeFlag === 'true' && rememberedUser) {
                try {
                    const user = JSON.parse(rememberedUser);
                    if (database.users[user.username] && database.users[user.username].password === user.password) {
                        document.getElementById('loginEmail').value = user.username;
                        document.getElementById('loginPassword').value = user.password;
                        document.getElementById('rememberMe').checked = true;
                    }
                } catch (e) {
                    localStorage.removeItem('primeSpeakRememberedUser');
                    localStorage.removeItem('primeSpeakRememberMe');
                }
            }
        }

        function showLoginError() {
            loginError.style.display = 'block';
            setTimeout(() => {
                loginError.style.display = 'none';
            }, 3000);
        }

        function logoutUser() {
            currentUser = null;
            localStorage.removeItem('primeSpeakRememberedUser');
            localStorage.removeItem('primeSpeakRememberMe');
            
            appContainer.style.display = 'none';
            loginPage.style.display = 'flex';
            
            loginForm.reset();
            loginError.style.display = 'none';
            
            showNotification('Вы успешно вышли из системы', 'success');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Функции для печати и других действий
        function printSchedule() {
            window.print();
        }

        // Заглушки для остальных функций (для полноты)
        function loadStudentsPage() {
            mainContent.innerHTML = '<h2>Страница учеников (админ)</h2>';
        }

        function loadTeachersPage() {
            mainContent.innerHTML = '<h2>Страница учителей (админ)</h2>';
        }

        function loadClassesPage() {
            mainContent.innerHTML = '<h2>Страница классов (админ)</h2>';
        }

        function loadProfilePage() {
            mainContent.innerHTML = '<h2>Профиль (админ)</h2>';
        }

        function loadTeacherAttendance() {
            mainContent.innerHTML = '<h2>Посещаемость (учитель)</h2>';
        }

        function loadTeacherTests() {
            mainContent.innerHTML = '<h2>Контрольные работы (учитель)</h2>';
        }

        function loadTeacherProfile() {
            mainContent.innerHTML = '<h2>Профиль учителя</h2>';
        }

        function loadStudentTests() {
            mainContent.innerHTML = '<h2>Мои контрольные работы</h2>';
        }

        function loadStudentProfile() {
            const student = database.students[currentUser.username];
            
            mainContent.innerHTML = `
                <div class="page-header">
                    <div class="page-title">
                        <h2><i class="fas fa-user"></i> Мой профиль</h2>
                    </div>
                    <div class="page-subtitle">
                        Личная информация и настройки
                    </div>
                </div>
                
                <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px;">
                        <div style="width: 100px; height: 100px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: bold;">
                            ${student?.name?.charAt(0) || 'У'}
                        </div>
                        <div>
                            <h3 style="font-size: 1.8rem; color: var(--dark); margin-bottom: 5px;">
                                ${student?.name || currentUser.name}
                            </h3>
                            <p style="color: var(--gray); font-size: 1rem;">Ученик</p>
                            <p style="color: var(--gray); font-size: 0.9rem;">
                                ${student?.email || '—'}
                            </p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                        <div>
                            <h4 style="color: var(--primary); margin-bottom: 15px;">Личная информация</h4>
                            <div style="background: var(--light); padding: 20px; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Класс:</span>
                                    <strong>${student?.class || '—'}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Учитель:</span>
                                    <strong>${database.teachers[student?.teacher]?.name || '—'}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Телефон:</span>
                                    <strong>${student?.phone || '—'}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Дата рождения:</span>
                                    <strong>${student?.birthDate || '—'}</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="color: var(--primary); margin-bottom: 15px;">Контактная информация</h4>
                            <div style="background: var(--light); padding: 20px; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Телефон родителя:</span>
                                    <strong>${student?.parentPhone || '—'}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Email:</span>
                                    <strong>${student?.email || '—'}</strong>
                                </div>
                            </div>
                            
                            <h4 style="color: var(--primary); margin-bottom: 15px; margin-top: 20px;">Действия</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <button class="btn btn-primary" onclick="changePassword()">
                                    <i class="fas fa-key"></i> Сменить пароль
                                </button>
                                <button class="btn btn-warning" onclick="showNotifications()">
                                    <i class="fas fa-bell"></i> Настройки уведомлений
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function changePassword() {
            showNotification('Функция смены пароля (в разработке)', 'warning');
        }

        function showNotifications() {
            showNotification('Настройки уведомлений (в разработке)', 'warning');
        }

        function createNewClass() {
            showNotification('Создание нового класса (доступно только администраторам)', 'warning');
        }

        function openClassDetails(className) {
            showNotification(`Детали класса ${className} (в разработке)`, 'info');
        }

        function deleteGrade(index) {
            if (confirm('Удалить эту оценку?')) {
                showNotification('Функция удаления оценок (в разработке)', 'warning');
            }
        }
    </script>
</body>
    </html>
